{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <style type="text/css">
        #map { /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height: 600px;
            width:600px;
        }
    </style>
{% endblock %}
{% block title %}
    Carte
{% endblock %}

{% block body %}

    <div id="map">
        <!-- Ici s'affichera la carte -->
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script type="text/javascript">
        // On initialise la latitude et la longitude de Paris (centre de la carte)
        var lat = 49.2534;
        var lon = 4.033;
        var macarte = null;


        // Fonction d'initialisation de la carte
        function initMap() {
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lon], 10);

            var southWest = L.latLng(49.235966602551215, 3.9849018126641855),
                northEast = L.latLng(49.28195626885696, 4.096275722413276),
                mybounds = L.latLngBounds(southWest, northEast);


            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © OpenStreetMap/ODbL - rendu OSM France',
                bounds: mybounds,
                minZoom: 14,
                maxZoom: 16
            }).addTo(macarte);
            // Nous parcourons la liste des villes
            macarte.setMaxBounds(macarte.getBounds());


            var Icon = L.Icon.extend({
                options: {
                    iconSize:     [24, 38],
                    iconAnchor:   [22, 94],
                    popupAnchor:  [-3, -76]
                }
            });
            var greenIcon = new Icon({iconUrl: '{{ asset('build/green.png') }}' }),
                redIcon = new Icon({iconUrl: '{{ asset('build/red.png') }}' }),
                orangeIcon = new Icon({iconUrl: '{{ asset('build/orange.png') }}'}),
                blueIcon = new Icon({iconUrl: '{{ asset('build/blue.png') }}'});


            {% for station in stations %}
            var marker;
            if({{ user.favStation.id }}=={{ station.id }}){
                marker = L.marker([{{ station.latitude }}, {{ station.longitude }}], { icon : blueIcon }).addTo(macarte);
            }
            else{
                switch({{ station.state }}){
                    case open:  marker = L.marker([{{ station.latitude }}, {{ station.longitude }}], { icon : greenIcon }).addTo(macarte);
                        break;
                    case close :  marker = L.marker([{{ station.latitude }}, {{ station.longitude }}], { icon : redIcon }).addTo(macarte);
                    break;
                    case 'under_work' : marker = L.marker([{{ station.latitude }}, {{ station.longitude }}], { icon : orangeIcon }).addTo(macarte);
                }

            }
            marker.bindPopup("<div><h1>{{ station.adresse }}</h1></div> <div>Vélos disponibles : {{ station.disponibility }}/{{ station.capacity }}</div><div><a href=\"{{ url('app_start_ride', { 'id_station': station.id }) }}\">Louer un vélo</a> <a href=\"{{ url('app_add_fav', { 'id_station': station.id }) }}\"> <i class=\"far fa-star favori\"></i></a></div>");
            {% endfor %}

        }

        window.onload = function () {
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
        };

    </script>
{% endblock %}